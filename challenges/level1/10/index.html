<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Ambiente - Pesquisa OA</title>
    <link rel="stylesheet" href="../../../static/css/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <style>
        #level-navigation{
            margin: 0;
            padding: 0;
            min-width: 350px;
            text-align: center;
        }

        #level-navigation>li{
            display: inline;
            padding: 5px;
        }

        #level-navigation>li>a{
            display: inline;
            padding: 0;
        }

        .current, .current:hover{
            cursor: default;
            font-weight: bold;
        }

        .navbar-brand{
            color: #FFF;
            font-size: 20px;
            font-weight: bold;
            margin-right: 0;
        }

        #navbarDropdown{
            font-size: 13px;
            margin-top: 5px;
        }

        .circles{
            position: absolute;
            width: 3px;
            height: 3px;
            border: 2px solid #80a4be;
            border-radius: 50%;
            padding: 5px;
            bottom: 20%;
            right: 20%;
        }

        .circles::before{
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid #80a4be;
            border-radius: 50%;
            padding: 8px;
            top: -150%;
            left: 100%;
        }
    </style>
</head>

<body>
    <div class="container-fluid p-0">
        <nav class="navbar navbar-expand m-0">
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Início</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="levels.html">Desafios</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tutorial.html">Tutorial</span></a>
                    </li>
                </ul>
            </div>
            <div class="collapse navbar-collapse w-100 justify-content-center">
                <a class="navbar-brand" href="../../../level1.html">
                    Level 1
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                        Desafio 10
                    </a>
                    <ul id="level-navigation" class="dropdown-menu col-12" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="../../basic/challenge1/game.html">1</a></li>
                        <li><a class="dropdown-item" href="../../basic/challenge1/game.html">2</a></li>
                        <li><a class="dropdown-item" href="../../basic/challenge1/game.html">3</a></li>
                        <li><a class="dropdown-item" href="../../basic/challenge1/game.html">4</a></li>
                        <li><a class="dropdown-item" href="../../basic/challenge1/game.html">5</a></li>
                        <li><a class="dropdown-item" href="#">6</a></li>
                        <li><a class="dropdown-item" href="#">7</a></li>
                        <li><a class="dropdown-item" href="#">8</a></li>
                        <li><a class="dropdown-item" href="#">9</a></li>
                        <li><a class="dropdown-item current" href="#">10</a></li>
                        <li><a class="dropdown-item" href="#">11</a></li>
                        <li><a class="dropdown-item" href="#">12</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
    <div id="mainDiv" style="height: 100%; width: 50%; float: left;">
        <div id="blocklyDiv" style="position: absolute;"></div>
        <xml id="toolbox" style="display: none;">
            <block type="controls_moveTo"></block>
            <block type="controls_buy"></block>
            <block type="controls_hasItem"></block>
            <block type="logic_if"></block>
        </xml>
    </div>
    <!-- Código fonte gerado a partir dos blocos (Python, no momento) -->
    <div id="codeDiv">
        <pre>
            <code id="codeToHighlight" class="python"></code>
        </pre>
    </div>
    <div id="gameDiv">
        <div id="game"></div>
        <button id="runGame">Executar</button>
        <div id="helper">
            <svg height="100%" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin-top: 5rem;">
                <image xlink:href="../../../static/img/CorujaAzulMarinhoBlink.png" x="0" y="0" height="100%" width="100%" />
                <circle cx="70" cy="30" r="5" stroke="#80a4be" fill="white"/>
                <circle cx="60" cy="20" r="8" stroke="#80a4be" fill="white"/>
                <text x="10" y="15" fill="black" >Olá!</text>
            </svg>
        </div>
    </div>
</body>

<script src="../../../libs/phaser/dist/phaser.js"></script>

<script src="../../../libs/blockly/blockly_uncompressed.js"></script>
<script src="./js/controls.js"></script>

<script src="../../../libs/blockly/blocks/custom/logic_blocks.js"></script>
<script src="../../../libs/blockly/generators/javascript/custom/logic_blocks.js"></script>

<script src="../../../libs/blockly/generators/javascript.js"></script>
<script src="../../../libs/blockly/generators/python.js"></script>
<script src="../../../libs/blockly/generators/python/controls.js"></script>
<script src="../../../libs/blockly/generators/javascript/controls.js"></script>
<script src="../../../libs/blockly/msg/js/pt-br.js"></script>

<script src="../../../static/js/BlockHighlighter.js"></script>
<script src="../../../static/js/BlockyResizer.js"></script>

<script src="../../../libs/jsinterpreter/acorn_interpreter.js"></script>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

<!--Highlight.js https://highlightjs.org/usage -->
<link rel="stylesheet" href="../../../libs/highlight/styles/github.css">
<script src="../../../libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
    /* 
    * Adiciona um listener de eventos a cada mudança ao ambiente do Blockly para atualizar o código fonte
    * Talvez haja algum evento melhor pra isso?
    * Ref: https://developers.google.com/blockly/guides/configure/web/events
    */
    workspace.addChangeListener(function () {
        let code = Blockly.Python.workspaceToCode(workspace);

        let selectedBlock = Blockly.selected;
        document.getElementById('codeToHighlight').innerHTML = generateHighlightableCode(code, selectedBlock);

        hljs.initHighlighting.called = false;
        hljs.initHighlighting();
    });

    // Faz um bloco brilhar
    function highlightBlock(id) {
        workspace.highlightBlock(id);
    }

    document.getElementById("runGame").onclick = function () {
        try {
            reset();

            // A cada execução de um bloco, chama highlightBlock(idDoBloco)
            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');

            let code = Blockly.JavaScript.workspaceToCode(workspace);

            // https://neil.fraser.name/software/JS-Interpreter/docs.html
            var initFunc = function (interpreter, scope) {
                blockHighlightWrapper = function (id) {
                    return workspace.highlightBlock(id);
                }

                interpreter.setProperty(
                    scope,
                    'moveTo',
                    interpreter.createNativeFunction(moveTo)
                );

                interpreter.setProperty(
                    scope,
                    'highlightBlock',
                    interpreter.createNativeFunction(blockHighlightWrapper)
                );
            };

            let interpreter = new Interpreter(code, initFunc);

            function nextStep() {
                if (interpreter.step())
                    window.setTimeout(nextStep, 50);
            }

            nextStep();
        }
        catch (e) {
            console.log(e);
        }
    };

    const PLAYER_SPAWN_POINT = { x: 80, y: 48 };

    var config = {
        type: Phaser.AUTO,
        width: document.getElementById("gameDiv").offsetWidth,
        height: document.getElementById("gameDiv").offsetHeight / 2,
        parent: "game",
        physics: {
            default: "arcade",
            gravity: { y: 0 },
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var player;

    var game = new Phaser.Game(config);

    var dest = {};

    function preload() {
        this.load.spritesheet(
            'char',
            '../../assets/char.png',
            { frameWidth: 32, frameHeight: 32 }
        );
        this.load.image('market', 'assets/market.png');
        this.load.image('hills', 'assets/hills.png');
        this.load.tilemapTiledJSON('map', 'assets/map.json');
    }

    function create() {

        const map = this.make.tilemap({ key: 'map' });
        
        var market = map.addTilesetImage('market', 'market');
        var hills = map.addTilesetImage('hills', 'hills');

        var terrain = map.createStaticLayer('Terrain', hills);
        var objects = map.createStaticLayer('Objects', market);
        var food = map.createStaticLayer('Food', market);

        this.cameras.main.setZoom(.4);
        this.cameras.main.centerOn(terrain.width / 2, terrain.height / 2);

        player = this.physics.add.sprite(
            PLAYER_SPAWN_POINT.x,
            PLAYER_SPAWN_POINT.y,
            'dude'
        );

        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('char', { start: 3, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [{ key: 'char', frame: 1 }],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('char', { start: 6, end: 8 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'up',
            frames: this.anims.generateFrameNumbers('char', { start: 9, end: 11 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'down',
            frames: this.anims.generateFrameNumbers('char', { start: 0, end: 2 }),
            frameRate: 10,
            repeat: -1
        });

        player.anims.play('turn', true);
    }

    function hasPlayerWon() {
        // TODO
        return false;
    }

    function win() {
        alert('!!!');
    }

    function reset() {
        player.x = PLAYER_SPAWN_POINT.x;
        player.y = PLAYER_SPAWN_POINT.y;
        player.anims.play('turn', true);
    }

    function moveTo(where){
        console.log(`Mover até ${where}`);
    }

    
    function update() {}

</script>

</body>

</html>

</html>