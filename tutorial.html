<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Ambiente - Pesquisa OA</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <style>
        body {
            font-family: 'Trebuchet MS';
            overflow: hidden;
        }

        button {
            background-color: #1e3d5a;
            color: #FFF;
            border: 0;
            padding: 5px;
            font-size: 1em;
        }
        
        #tutorial{
            position: absolute;
            width: 100%;
            height: 100%;
        }

        #intro {
            background-color: #80a4be;
            position: absolute;
            padding: 5px;
            border-radius: 5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgb(235, 235, 235);
            z-index: 999;
        }
        
        #intro p {
            padding: 0;
            margin: 0;
        }

        #info{
            position: absolute;
            display: none;
            right: 0;
            z-index: 999;
            width: 50%;
            margin: 5px;
        }

        #info>span{
            flex: 3;
            background-color: #398689;
            margin-left: 5px;
            padding: 10px;
            color: #FFF;
        }
        
        #info-text a{
            color: #A7DDA7;
        }

        .pet{
            flex: 1;
        }
        
        .circles{
            position: absolute;
            width: 3px;
            height: 3px;
            border: 2px solid #80a4be;
            border-radius: 50%;
            padding: 5px;
            top: 20%;
            left: 20%;
        }

        .circles::before{
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid #80a4be;
            border-radius: 50%;
            padding: 8px;
            top: -150%;
            left: 100%;
        }
        
        .blocklyWsDragSurface{ overflow: visible !important;}

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid h-100 p-0">
        <div id="tutorial">
            <div id="intro">
                <p>O ambiente consiste de 3 elementos principais:</p>
                <button onclick="nextStep()" id="start" disabled>Prosseguir</button>
            </div>
            <div id="info">
                <div class="pet">
                    <svg height="100%" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <image xlink:href="static/img/mascote.jpg" x="0" y="0" height="100%" width="100%">
                            <animate attributeName="href" from="static/img/mascote.jpg" to="static/img/mascote_closed.jpg"
                                dur="1s" repeatCount="indefinite" />
                        </image>
                    </svg>
                </div>
                <div class="circles"></div>
                <span>
                    <span id="info-text"></span>
                    <hr>
                    <button onclick="nextStep()">Prosseguir</button>
                    <button onclick="previousStep()">Voltar</button>
                </span>
            </div>
            <!--</div>
                        <div class="info">
                            <img src="static/img/mascote.jpg" class="pet">
                            Esta área contém a tradução dos blocos para a linguagem de programação <a href='https://www.python.org/'
                                target='_blank'>Python</a>.
                            <hr>
                            <button onclick="nextStep()">Prosseguir</button>
                            <button onclick="previousStep()">Voltar</button>
                        </div>
                        <div class="info">
                            <img src="static/img/mascote.jpg" class="pet" style="transform: rotate(180deg);">
                            É aqui que o jogo será executado e você poderá acompanhar o resultado.
                            <hr>
                            <button onclick="nextStep()">Prosseguir</button>
                            <button onclick="previousStep()">Voltar</button>
                        </div>-->
            <div class="row h-100">
                <div class="col">
                    <div id="mainDiv" style="opacity: .1;" class="row h-100">
                        <div id="blocklyDiv"></div>
                        <xml id="toolbox" style="display: none;">
                            <block type="controls_moveUp"></block>
                            <block type="controls_moveDown"></block>
                            <block type="controls_moveLeft"></block>
                            <block type="controls_moveRight"></block>
                            <block type="controls_if"></block>
                        </xml>
                    </div>
                </div>
                <div class="col">
                    <!-- Código fonte gerado a partir dos blocos (Python, no momento) -->
                    <div id="codeDiv" style="opacity: .1;" class="row h-100">
                        <pre>
                        <code id="codeToHighlight" class="python"></code>
                    </pre>
                    </div>
                </div>

                <div class="col">
                    <div id="gameDiv" style="opacity: .1;" class="row h-100">
                        <div class="col">
                            <div class="row">
                                <canvas id="game"></canvas>
                            </div>
                            <div class="row"><button id="runGame">Executar</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    window.onload = function () {
        document.getElementById('start').disabled = false;
    };

    let steps = {
        INTRO: 0,
        TOOLBOX: 1,
        TOOLBOX_TRY: 2,
        CODE: 3,
        GAME: 4
    }

    let lastFocus = document.getElementById('mainDiv');
    let currentStep = steps.INTRO;

    function nextStep() {
        if (currentStep < steps.GAME) {
            currentStep++;
            render();
        } else {
            window.location.href = 'levels.html';
        }
    }

    function previousStep() {
        if (currentStep > steps.INTRO) {
            currentStep--;
            render();
        }
    }

    function focus(element) {
        element.style.opacity = 1;
        element.style.border = '3px solid #57859c';
        lastFocus = element;
    }

    function unfocus() {
        lastFocus.style.opacity = '.1';
        lastFocus.style.border = 'none';
    }

    function clear() {
        document.getElementById('info').style.marginRight = "0";
        document.getElementById('runGame').style.animation = 'none';
        document.getElementsByClassName('blocklyDraggable')[3].style.animation = 'none';
    }

    function setText(text) {
        document.getElementById('info-text').innerHTML = text;
    }

    function render() {
        unfocus();
        clear();
        switch (currentStep) {
            case steps.INTRO:
                document.getElementById('intro').style.display = 'block';
                document.getElementById('info').style.display = 'none';
                break;

            case steps.TOOLBOX:
                setText("Essa área contém todos os blocos disponíveis para você usar durante o nível.");
                document.getElementById('intro').style.display = 'none';
                document.getElementById('info').style.display = 'flex';

                document.getElementById('mainDiv').style.pointerEvents = "none";

                focus(document.getElementById('mainDiv'));
                break;

            case steps.TOOLBOX_TRY:
                let defaultText = `Agora vamos tentar utilizar um desses blocos. Tá vendo aquele bloco brilhando? <br>
                Clica nele e arrasta até a parte branca. Vamos chamar essa parte de <i>área de trabalho</i>.
                Todos os blocos que tiverem ali serão executados.`;
                setText(defaultText);

                //Libera o uso do mouse na div
                document.getElementById('mainDiv').style.pointerEvents = "auto";
                //Highlight no bloco mover para direita, indicando ao jogador qual bloco selecionar
                let block = document.getElementsByClassName('blocklyDraggable')[3];

                block.style.animation = 'blink 1s infinite';

                workspace.addChangeListener(function (e) {
                    let answer = false;
                    let blocks = workspace.getAllBlocks();
                    if (blocks.length == 0) {
                        setText(defaultText);
                        answer = false;
                    }
                    else if (blocks.length > 1) {
                        setText(`Tem blocos demais aí....`);
                        answer = false;
                    }

                    for (let i = 0; blocks.length == 1 && i < blocks.length; ++i) {
                        if (blocks[i].type == 'controls_moveRight') {
                            setText(`Isso aí!`);
                            answer = true;
                        } else {
                            answer = false;
                            setText(`Esse não é o bloco certo........`);
                        }
                    }

                    if (!answer) {
                        block.style.animation = 'blink 1s infinite';
                        //Desabilitar botão
                    } else {
                        workspace.removeChangeListener();
                    }
                });

                focus(document.getElementById('mainDiv'));
                break;

            case steps.CODE:
                setText(`Essa é a <i>área de código</i>. Os blocos que forem adicionados à área de trabalho
                serão convertidos para código-fonte aqui. Nesse ambiente estaremos utilizando a linguagem de programação
                <a href='https://python.org'>Python</a>`);
                focus(document.getElementById('codeDiv'));
                break;

            case steps.GAME:
                setText(`E é aqui que a ação acontece. Na <i>área de jogo</i> é onde os seus comandos serão executados
                dentro do jogo. Vamos ver como funciona? Clique no botão <u>Executar</u>`);
                document.getElementById('info').style.marginRight = "40%";
                document.getElementById('runGame').style.animation = 'blink 1s infinite';
                focus(document.getElementById('gameDiv'));
                break;
        }
    }

    render();
</script>

<script src="./libs/blockly/blockly_uncompressed.js"></script>
<script src="./static/js/level1/controls.js"></script>
<script src="./libs/blockly/blocks/logic.js"></script>
<script src="./libs/blockly/generators/python.js"></script>
<script src="./libs/blockly/generators/python/controls.js"></script>
<script src="./libs/blockly/generators/python/logic.js"></script>
<script src="./libs/blockly/generators/python/loops.js"></script>
<script src="./libs/blockly/generators/python/math.js"></script>
<script src="./libs/blockly/generators/python/text.js"></script>
<script src="./libs/blockly/generators/python/lists.js"></script>
<script src="./libs/blockly/generators/python/colour.js"></script>
<script src="./libs/blockly/generators/python/variables.js"></script>
<script src="./libs/blockly/generators/python/procedures.js"></script>
<script src="./libs/blockly/generators/javascript.js"></script>
<script src="./libs/blockly/generators/javascript/controls.js"></script>
<script src="./libs/blockly/generators/javascript/logic.js"></script>
<script src="./libs/blockly/msg/js/pt-br.js"></script>

<script src="./static/js/tileManager.js"></script>
<script src="./static/js/BlockHighlighter.js"></script>

<link rel="stylesheet" href="./libs/highlight/styles/github.css">
<script src="./libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
    /* 
    * Código criado pelo Google para redimensionar a área do blockly
    * Ref: https://developers.google.com/blockly/guides/configure/web/resizable
    */
    var blocklyArea = document.getElementById('mainDiv');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject(blocklyDiv,
        { toolbox: document.getElementById('toolbox') });
    var onresize = function (e) {
        // Compute the absolute coordinates and dimensions of blocklyArea.
        var element = blocklyArea;
        var x = 0;
        var y = 0;
        do {
            x += element.offsetLeft;
            y += element.offsetTop;
            element = element.offsetParent;
        } while (element);
        // Position blocklyDiv over blocklyArea.
        blocklyDiv.style.left = x + 'px';
        blocklyDiv.style.top = y + 'px';
        blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
        blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
        Blockly.svgResize(workspace);
    };
    window.addEventListener('resize', onresize, false);
    onresize();
    Blockly.svgResize(workspace);

    workspace.addChangeListener(function () {
        let code = Blockly.Python.workspaceToCode(workspace);

        let selectedBlock = Blockly.selected;
        document.getElementById('codeToHighlight').innerHTML = generateHighlightableCode(code, selectedBlock);

        hljs.initHighlighting.called = false;
        hljs.initHighlighting();

    });

    // Faz um bloco brilhar
    function highlightBlock(id) {
        workspace.highlightBlock(id);
    }
</script>

</html>